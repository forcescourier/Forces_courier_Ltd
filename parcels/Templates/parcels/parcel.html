{%extends 'base.html'%}
{%block title%}<title>Parcel</title>{%endblock%}
{%block content%}
 <!--**********************************
            Content body start
        ***********************************-->
        <div class="content-body">
            <div class="container-fluid">
                <div class="row page-titles mx-0">
                    <div class="col-sm-6 p-md-0">
                        <div class="welcome-text">
                            <span>Manage all parcels and track their status</span>
                        </div>
                    </div>
                    <div class="col-sm-6 p-md-0 justify-content-sm-end mt-2 mt-sm-0 d-flex">
                        <div class="d-flex align-items-center">
                            <!-- Action Navigation Buttons --> 
                            <!-- Breadcrumb -->
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="{% url "dashboard"%}">Home</a></li>
                                <li class="breadcrumb-item active"><a href="{% url "parcel"%}">Parcels</a></li>
                            </ol>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons and Bulk Actions Section -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <!-- Action Buttons -->
                        <div class="btn-group">
                            <a href="{% url 'add_parcel'%}" class="btn btn-primary btn-sm" title="Add New Parcel">
                                <i class="fas fa-plus"></i> Add New Parcel
                            </a>
                            <a href="bulk-import.html" class="btn btn-outline-secondary btn-sm" title="Bulk Import">
                                <i class="fas fa-upload"></i> Bulk Import
                            </a>
                            <a href="export-parcels.html" class="btn btn-outline-secondary btn-sm" title="Export Data">
                                <i class="fas fa-download"></i> Export Data
                            </a>
                            <a href="track-parcel.html" class="btn btn-outline-secondary btn-sm" title="Track Parcel">
                                <i class="fas fa-search-location"></i> Track Parcel
                            </a>
                            <button class="btn btn-outline-secondary btn-sm" onclick="refreshTable()" title="Refresh">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <!-- Bulk Actions Section -->
                        <div class="d-flex justify-content-end align-items-center" style="position: relative;">
                            <div class="btn-group" id="bulkActionForm">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleStatusMenu()" id="statusBtn">
                                    <i class="fas fa-tasks"></i> Select Status
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleRiderMenu()" id="riderBtn">
                                    <i class="fas fa-user"></i> Select Rider
                                </button>
                                <button type="button" class="btn btn-success btn-sm" onclick="submitBulkSelection()">
                                    <i class="fas fa-check"></i> Submit
                                </button>
                            </div>
                            
                            <!-- Status Selection Menu -->
                            <div id="statusMenu" style="display: none; position: absolute; top: 100%; right: 250px; z-index: 1060; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 8px; min-width: 180px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <div style="font-weight: bold; margin-bottom: 5px; color: #007A64;">Select Status:</div>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectStatus('pending')" style="text-align: left;">⏳ Pending</button>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectStatus('pickup')" style="text-align: left;">📦 Pickup Assigned</button>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectStatus('transit')" style="text-align: left;">🚚 In Transit</button>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectStatus('delivery')" style="text-align: left;">🚛 Out for Delivery</button>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectStatus('delivered')" style="text-align: left;">✅ Delivered</button>
                                <button type="button" class="btn btn-light btn-sm btn-block" onclick="selectStatus('returned')" style="text-align: left;">↩️ Returned</button>
                            </div>
                            
                            <!-- Rider Selection Menu -->
                            <div id="riderMenu" style="display: none; position: absolute; top: 100%; right: 100px; z-index: 1060; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 8px; min-width: 180px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <div style="font-weight: bold; margin-bottom: 5px; color: #007A64;">Select Rider:</div>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectRider('rider1')" style="text-align: left;">👤 Ahmed Rahman</button>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectRider('rider2')" style="text-align: left;">👤 Karim Uddin</button>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectRider('rider3')" style="text-align: left;">👤 Nasir Mahmud</button>
                                <button type="button" class="btn btn-light btn-sm btn-block mb-1" onclick="selectRider('rider4')" style="text-align: left;">👤 Salma Begum</button>
                                <button type="button" class="btn btn-light btn-sm btn-block" onclick="selectRider('rider5')" style="text-align: left;">👤 Fahim Hassan</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comprehensive Parcels Management -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <!-- Simplified Filter Section -->
                                <div class="filter-row">
                                    <div class="row align-items-center" id="filterForm">
                                        <div class="col-md-3">
                                            <input type="text" class="form-control form-control-sm" id="searchFilter" 
                                                   placeholder="🔍 Search parcels, names, phones...">
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-control form-control-sm" id="statusFilter">
                                                <option value="">📋 All Status</option>
                                                <option value="pending">⏳ Pending</option>
                                                <option value="pickup">📦 Pickup Assigned</option>
                                                <option value="transit">🚚 In Transit</option>
                                                <option value="delivery">🚛 Out for Delivery</option>
                                                <option value="delivered">✅ Delivered</option>
                                                <option value="returned">↩️ Returned</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <select class="form-control form-control-sm" id="areaFilter">
                                                <option value="">🗺️ All Areas</option>
                                                <option value="dhaka">📍 Dhaka</option>
                                                <option value="chittagong">📍 Chittagong</option>
                                                <option value="sylhet">📍 Sylhet</option>
                                                <option value="rajshahi">📍 Rajshahi</option>
                                                <option value="barisal">📍 Barisal</option>
                                                <option value="cumilla">📍 Cumilla</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="date" class="form-control form-control-sm" id="dateFromFilter" placeholder="📅 From Date">
                                        </div>
                                        <div class="col-md-2">
                                            <input type="date" class="form-control form-control-sm" id="dateToFilter" placeholder="📅 To Date">
                                        </div>
                                        <div class="col-md-1">
                                            <div class="btn-group w-100">
                                                <button type="button" class="btn btn-light btn-sm" onclick="applyFilters()" title="Apply Filters">
                                                    <i class="fas fa-filter"></i>
                                                </button>
                                                <button type="button" class="btn btn-outline-light btn-sm" onclick="clearFilters()" title="Clear All">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table id="parcelsTable" class="table table-striped parcels-table mb-0">
                                        <thead class="thead-primary">
                                            <tr>
                                                <th style="width: 3%;">
                                                    <div class="custom-control custom-checkbox">
                                                        <input type="checkbox" class="custom-control-input" id="selectAll" onchange="toggleSelectAll()">
                                                        <label class="custom-control-label" for="selectAll"></label>
                                                    </div>
                                                </th>
                                                <th style="width: 12%;">Parcel Details</th>
                                                <th style="width: 22%;">Sender Details</th>
                                                <th style="width: 22%;">Receiver Details</th>
                                                <th style="width: 24%;">Payment & Details</th>
                                                <th style="width: 13%;">Notes</th>
                                                <th style="width: 4%;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                             {% for parcel in parcels %}
                                             <tr>
                                                <td>
                                                     <div class="custom-control custom-checkbox">
                                                         <input type="checkbox" class="custom-control-input parcel-checkbox" id="parcel{{parcel.parcels_id}}" value="{{parcel.parcels_id}}">
                                                          <label class="custom-control-label" for="parcel{{parcel.parcels_id}}"></label>
                                                     </div>
                                                </td>
                                                <td class="parcel-details-info">
                                                      <div class="mb-1"><strong class="font-weight-bold text-primary">#{{parcel.parcels_id}}</strong></div>
                                                      <div class="mb-1"><span class="text-muted">MI: INV-2024-{{parcel.parcels_id|stringformat:"03d"}}</span></div>
                                                      <div><span class="text-muted">Date:</span> <small class="text-muted">{{parcel.created_at|date:"Y-m-d H:i A"}}</small></div>
                                                </td>
                                                <td class="sender-receiver-info">
                                                        <div class="mb-1"><span class="info-label">Name:</span> {{parcel.parcels_merchant_id.merchant_name}}</div>
                                                        <div class="mb-1"><span class="info-label">Phone:</span> {{parcel.parcels_merchant_id.merchant_phone}}</div>
                                                        <div><span class="info-label">Address:</span> {{parcel.parcels_merchant_id.merchant_pickup_address}}</div>
                                                </td>
                                                <td class="sender-receiver-info">
                                                        <div class="mb-1"><span class="info-label">Name:</span> {{parcel.parcels_customer_name}}</div>
                                                        <div class="mb-1"><span class="info-label">Phone:</span> {{parcel.parcels_customer_phone}}</div>
                                                        <div><span class="info-label">Address:</span> {{parcel.parcels_customer_address}}</div>
                                                </td>
                                                <td class="amount-info">
                                                        <div class="mb-0"><span class="info-label">Weight:</span> <strong>{{parcel.parcels_weight_kg}} kg</strong></div>
                                                        <div class="mb-0"><span class="info-label">Area:</span> {{parcel.delivery_area|title}}</div>
                                                        <div class="mb-0"><span class="info-label">Charge:</span> ৳{{parcel.selected_price}}</div>
                                                        <div class="mb-0"><span class="info-label">COD:</span> ৳{{parcel.parcels_cash_collection}}</div>
                                                        <div class="mb-1"><span class="info-label">Payable:</span> <span class="text-success font-weight-bold">৳{{parcel.payable|floatformat:2}}</span></div>
                                                       
                                                        <div>
                                                          <span class="badge 
                                                               {% if parcel.parcel_status == 'pending' %}badge-warning
                                                               {% elif parcel.parcel_status == 'in_transit' %}badge-info
                                                               {% elif parcel.parcel_status == 'pickup_assigned' %}badge-success
                                                               {% elif parcel.parcel_status == 'delivered' %}badge-success
                                                               {% elif parcel.parcel_status == 'out_of_delivery' %}badge-warning
                                                               {% else %}badge-secondary{% endif %}">
                                                                {{ parcel.parcel_status }}
                                                         </span>
                                                        </div>
                                                        </td>
                                                              <td class="sender-receiver-info">{{parcel.parcels_item_desc}}{% if parcel.parcels_note %}. {{parcel.parcels_note}}{% endif %}</td>
                                                              <td class="text-center">
                                                                <div class="btn-group">
                                                                   <a href="{% url 'parcel_detail' parcel.parcels_id %}" class="btn btn-primary btn-sm" title="View Details">
                                                                        <i class="fas fa-eye"></i>
                                                                   </a>
                                                                   <button class="btn btn-success btn-sm" title="Actions" onclick="openActionModal('{{parcel.parcels_id}}')">
                                                                       <i class="fas fa-cog"></i>
                                                                   </button>
                                                                   <a href="{% url "edit_parcel" parcel.parcels_id%}" class="btn btn-info btn-sm" title="Edit">
                                                                      <i class="fas fa-edit"></i>
                                                                  </a>
                                                                </div>
                                                              </td>
                                                           </tr>
                                                            {% empty %}
                                                            <tr>
                                                               <td colspan="7" class="text-center">No parcels found.</td>
                                                            </tr>
                                                           {% endfor %}
                                        </tbody>

                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--**********************************
            Content body end
        ***********************************-->
{%endblock%}